<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <title>Fantalucca 2K22</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script src='index.js'></script>
</head>

<style>
	@import url('https://fonts.googleapis.com/css2?family=M+PLUS+2:wght@300&display=swap');
	*{ 
		font-family: 'M PLUS 2', sans-serif;}	
		font-weight:400;		
	 }
	 .squadra{
		color: #fd44aa;
		border: solid 4px #ffa000;
		border-radius:10px;
		padding:10px;	 
	 }
	 
	 .freccia{
		font-size:20px;
		color:#66d90e;
	 }
	 .titolo{
		text-align: center;
		font-size: 1.5em;
		font-weight: bold;	
	}
</style>
 
<body  style = "background-color:#123456; color:#ffffff;">
		<img src='Logo.ico' style='float:right; margin:5px; height:35px;'>
	<div id="divMenu"  class="container-fluid" style="  padding: 10px; white-space: nowrap; overflow-x: auto;">               
		<h4 class='titolo' onclick=' '>FantaLucca 2K22 </h4>
		<button id='btnMenuRisultati' class='btn btn-success' style="width: 50%" onclick="CambiaPagina('C')">Classifica</button>
		<button id='btnMenuRanking' class='btn btn-primary' style="width: 50%" onclick="CambiaPagina('P')">Punteggi</button>				
	</div>	
	<div class="container-fluid ElencoGiocatori" style="width:100%; padding: 0; ">		 		
		<h4 class="text-center">Classifica</h4>
		 
		<div id='divGiovatori' class='col-xs-12'>			 			
										
		</div>			
	</div> 
		
	<div class="container-fluid ElencoPunteggi" style="width:100%; padding: 0; display:none;  ">
		<h4 class="text-center">Punteggi</h4> 
		<div id='aaa'>
		
		</div>	
	</div>		
	<div class="container-fluid" style="height:80px;"></div>
</body> 

<script>
var url = 'https://us-central1-oloappi.cloudfunctions.net/user';
var arrGiocatori;
var arrPunteggiTotali;
//////var punteggi1,punteggi2,punteggi3,punteggi4
var punteggi = [];
var azioni;

$(document).ready(function(){
	arrGiocatori=[];
	arrPunteggiTotali=[];
	CambiaPagina('C');
	getGiocatori();	
	
	getPunteggi(1);
	getPunteggi(2);
	getPunteggi(3);
	getPunteggi(4);
	getAzioni();
	
	setTimeout(function(){
		GetPunteggioGiocatore();			
	}, 1500);	 	
}); 
	
function getAzioni(){
	$.ajax({  
	"Access-Control-Allow-Origin": "*",
		"Referrer Policy": "strict-origin-when-cross-origin",
		"url": "https://us-central1-oloappi.cloudfunctions.net/user/GetDati/azioni",   
		"method": "GET",
		"crossDomain": false,
		"dataType":"text",	
		"async" : false,			
		success: function (output)  
		{								
			azioni = JSON.parse(output);
		} ,
		 error: function(output) 
		 {					 
			console.log("Error in API getAzioni call:" + output);
			alert("Error in API getAzioni call:" + output);
		 }
			
	}); 
	
}
	
function getPunteggi(giorno){
	$.ajax({  
	"Access-Control-Allow-Origin": "*",
		"Referrer Policy": "strict-origin-when-cross-origin",
		"url": "https://us-central1-oloappi.cloudfunctions.net/user/GetDati/punteggi_" + giorno,   
		"method": "GET",
		"crossDomain": false,
		"dataType":"text",	
		"async" : false,			
		success: function (output)  
		{								
			punteggi[giorno -1] = JSON.parse(output);
		} ,
		 error: function(output) 
		 {					 
			console.log("Error in API getPunteggi_" + i + " call:" + output);
			alert("Error in API getAzioni_" + i + " call:" + output);
		 }
			
	}); 
	
}	
 
function getGiocatori(){		
	$.ajax({  
	"Access-Control-Allow-Origin": "*",
		"Referrer Policy": "strict-origin-when-cross-origin",
		"url": "https://us-central1-oloappi.cloudfunctions.net/user/GetDati/users",   		
		"method": "GET",
		"crossDomain": false,
		"dataType":"text",	
		"async" : false,			
		success: function (output )  
		{							  										
			 
			localStorage["giocatori"] =  output;
					
			//;
			let ret = JSON.parse(output)
			for(let k = 0; k < ret.length; ++k){
				let y = ret[k].nome
				arrGiocatori.push(y);	
			}
					
			popolaClassifica(ret);
		} ,
		 error: function(output) 
		 {					
			console.log("Error in API getGiocatori call:" + output);
			alert("Error in API getGiocatori call:" + output);
		 }
			
	}); 	 
 }
 
function popolaClassifica(arr){
	//;
	let sHTML = '';
	 
	sHTML += `<div class='col-xs-12' style='margin-bottom: 10px; font-size: 16px;'></div>`
	for (let i = 0; i< arr.length; ++i){
		//TODO CONTINUARE E SCOMMENTAE	e usare sotto   &nbsp;${totali[0]}
	//let index = [arrGiocatori.indexOf(arr[i].squadra.draft_1), arrGiocatori.indexOf(arr[i].squadra.draft_2), arrGiocatori.indexOf(arr[i].squadra.draft_3)];
	//let totali = [arrPunteggiTotali[index[0]], arrPunteggiTotali[index[1]], arrPunteggiTotali[index[2]]];	 
	//let totCurrentPlayer = arrPunteggiTotali[indexCurrentPlayer];
		
	sHTML += `
	<div class='col-xs-6 Giocatore ${arr[i].nome}'>
		<div class='col-xs-12 squadra' style='border: solid 1px #ffa500; border-radius:10px; padding:5px;margin-bottom:10px;'>
			<b style='margin-left: 5px;'>${arr[i].nome}</b>&nbsp;
			<i class='hidden'>${arr[i].id}</i>
			<ul>
				<li>${arr[i].squadra.draft_1}</li>
				<li>${arr[i].squadra.draft_2} </li>
				<li>${arr[i].squadra.draft_3} </li>
			</ul>			
		</div>
	</div>`	
	}
 
	$('#divGiovatori').html(sHTML);
 
 }
 
 function CambiaPagina(p){
	 switch(p){
		 case "C":
			$('.ElencoPunteggi').css('display', 'none');
			$('.ElencoGiocatori').css('display', '');
			break;		 
		 case "P":
			$('.ElencoPunteggi').css('display', '');
			$('.ElencoGiocatori').css('display', 'none');
			break;		 		 
	 }
	 
 }
  
 function GetPunteggioGiocatore(){
	 let punteggi1 = punteggi[0];
	 let punteggi2 = punteggi[1];
	 let punteggi3 = punteggi[2];
	 let punteggi4 = punteggi[3];
	
	 let sHTML = ''; 
	 let sNone = ''
	 for (i = 0; i < arrGiocatori.length; ++i){
	 	sHTML += creaHTMLgiocatore(punteggi1,punteggi2,punteggi3,punteggi4, arrGiocatori[i], sNone);
		sNone = 'display:none;'
	 }
	 $('#aaa').html(sHTML);
 }
 
 function creaHTMLgiocatore(giorno1,giorno2,giorno3, giorno4, player,sNone){
	let index = arrGiocatori.indexOf(player);
	let p1 = giorno1[index];	
	let p2 = giorno2[index];	
	let p3 = giorno3[index];	
	let p4 = giorno4[index];	
	let n = Object.keys(p1).length/2; 
	let sHTML = '';
	let tot = 0;
	
	sHTML +='<div id="div' + player + '" style="' + sNone + '">'
	sHTML +='<div class="col-xs-12">'
	let w = "'" + player + "'"
	sHTML +='<div class="col-xs-2"></div><div class="col-xs-2"><span class="glyphicon glyphicon-arrow-left freccia ' +player +'" onclick="Freccia(-1,' + w + ')"></span></div>'
	sHTML +='<div class="col-xs-4"><b style="font-size:20px; margin-top: -5px">' + player + '</b></div>'
	sHTML +='<div class="col-xs-2"><span class="glyphicon glyphicon-arrow-right freccia"  onclick="Freccia(+1,' + w + ')"></span></div><div class="col-xs-2"></div>'
	sHTML +='</div>'
	sHTML +='<div class="col-xs-12">'
	sHTML +='<table style="width:100%">'
	sHTML +='<tr>'
	sHTML +='<th>AZIONE</th>'
	sHTML +='<th class="text-center">PUNTI</th>	'		
	sHTML +='</tr>'
	for (let i = 1; i<= azioni.length -1 ; ++i){
		let descrizione = getDescAzione(i-1);  //azioni[i-1].descrizione;
		let punteggio = 'AZ' +i;
		let somma =  parseInt(p1[punteggio])+parseInt(p2[punteggio])+parseInt(p3[punteggio])+parseInt(p4[punteggio]);
		tot+=somma;
		//debugger;
		sHTML +='<tr>'
		sHTML +='<td>' + descrizione + '</td>'
		sHTML +='<td class="text-center">' + somma + '</td>'
		sHTML +='</tr>'		
	}
	
	sHTML +='</table>'
	
	sHTML += '<div class="col-xs-11" style="text-align: right; margin-top: 15px;">'
	sHTML += '<b>Tot.</b>&nbsp;' + tot +' punti'
	sHTML += '</div>'
	
	sHTML +='</div>'
	sHTML +='</div>' //chiudo il divGiocatore
 
	//let indexPlayer = arrGiocatori.indexOf(player)
	arrPunteggiTotali[index] = tot;
	return sHTML;
 }
 
 function Freccia(i, currentPlayerName){
  
	 let currentIndex = arrGiocatori.indexOf(currentPlayerName);
	 let n = arrGiocatori.length;
	 let next = (parseInt(currentIndex) + parseInt(i) + n) % n;
	  
	 let nextPlayerName = arrGiocatori[next];
	 //nascondo il corrente e mostroil prossimo
	 $('#div' + currentPlayerName).css('display', 'none');
	 $('#div' + nextPlayerName).css('display', '');
 }
 
 
 function getDescAzione(i){
	 let j = i+1;
	 for (k =0; k<= azioni.length - 1;++k){		
		 if(azioni[k].id == 'AZ' + j) {
			 return azioni[i].descrizione;	
		 }	 
	 }	 
	 return 'DESC NON TROVATA';
 }
</script>
</html>